---
title: "Evaluación asigunaturas Visualización de datos y Visualización de la información"
subtitle: 'Gráficas con ggplot'
author: "Inmaculada Perea Fern?ndez"
date: "Agosto 2017"
output: pdf_document
---

El conjunto de datos elegido para este trabajo es uno de los datasets de aprendizaje de kaggle, en el que el objetivo es predecir el precio de venta de viviendas (variable objetivo *SalePrice*) a partir de sus características. 

Para más información ir a:

https://www.kaggle.com/c/house-prices-advanced-regression-techniques



# 1. Carga de librerías y opciones por defecto
```{r message=FALSE, warning=FALSE}
if (!require('Rcpp')) install.packages('Rcpp'); library('Rcpp')
if (!require('naniar')) install.packages('naniar'); library('naniar')
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
if (!require('scales')) install.packages('scales'); library('scales')
if (!require('forcats')) install.packages('forcats'); library('forcats')
if (!require('GGally')) install.packages('GGally'); library('GGally')
if (!require('mi')) install.packages('mi'); library('mi')
if (!require('extracat')) install.packages('extracat'); library('extracat')
if (!require('data.table')) install.packages('data.table'); library('data.table')
if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
if (!require('maps')) install.packages('maps'); library('maps')
if (!require('ggalt')) install.packages('ggalt'); library('ggalt')
if (!require('ggExtra')) install.packages('ggExtra'); library('ggExtra')
```


```{r}
# deshabilita la notación científica
options(scipen=999)

# Establece tema por defecto
theme_set(theme_bw())
```



# 2. Carga y resumen de los datos 
```{r}
data <- read.csv("data/train.csv", header=T, dec=".", sep=",")
dim(data)
summary(data)
str(data)
```


# 3. Análisis Gráfico de datos

```{r}
luxury <- data %>% filter(SalePrice > 500000)

ggplot(data, aes( x=TotalBsmtSF, y=SalePrice)) + 
  geom_point(aes(col=SaleCondition, size=OverallCond)) + 
  geom_smooth(method="loess", se=F) + 
  geom_encircle(aes(x=TotalBsmtSF, y=SalePrice), 
                data=luxury, 
                color="red", 
                size=2, 
                expand=0.08) +
  labs(y="Precio de venta", 
       x="Tamaño del sótano", 
       title="Precio de venta Vs Tamaño del sótano")

```


```{r}
ggplot(data, aes(x=SalePrice)) + 
  geom_histogram(col = 'white') + 
  theme_light() +
  scale_x_continuous(labels = comma)
```




```{r}
ggplot(data, aes(x=OverallQual, y=SalePrice)) +
geom_point() +
facet_wrap('Neighborhood')
```

```{r}
ggplot(data, aes(x=OverallQual, y=SalePrice)) +
geom_point() +
facet_wrap('Neighborhood', scales='free_x')
```
```{r}
ggplot(data, aes(x=SaleCondition, y=SalePrice)) +
geom_point()
```


```{r}
g <- ggplot(data, aes(GarageArea, SalePrice)) + 
  geom_count() + 
  geom_smooth(method="lm", se=F)

g2<-ggMarginal(g, type = "histogram", fill="transparent")
plot(g2)
```

```{r}
g <- ggplot(data, aes(YearBuilt, SalePrice)) + 
  geom_count() + 
  geom_smooth(method="lm", se=F)

g2<-ggMarginal(g, type = "histogram", fill="transparent")
plot(g2)
```


```{r}
ggplot(data, aes(x=GarageArea, y=SalePrice)) +
geom_point() +
scale_y_log10() +
stat_ellipse(type='norm')
```



```{r}
ggplot(data, aes(x=OverallQual, y=SalePrice, colour=Neighborhood)) + 
  geom_point()
```


```{r}
ggplot(data, aes(x=YearBuilt, y=SalePrice, colour=as.factor(OverallQual))) + 
  geom_point()
```



```{r}
ggplot(data, aes(x=YearBuilt, y=SalePrice, colour=KitchenQual)) + geom_point()
```


```{r}
ggplot(data, aes(x=YearBuilt, y=SalePrice, colour=GarageArea)) + 
  geom_point() +
  theme_light() + 
  scale_colour_gradientn(colours=rainbow(6))
```

```{r}
ggplot(data, aes(x=TotalBsmtSF, y=SalePrice, color=LotConfig)) + 
  geom_point()
```

```{r}
ggplot(data, aes(x=as.factor(MoSold), y=SalePrice)) + 
  geom_point(col="tomato2", size=1.5) +  
  geom_segment(aes(x=MoSold, 
                   xend=MoSold, 
                   y=min(SalePrice), 
                   yend=max(SalePrice)), 
               linetype="dashed", 
               size=0.1) +  
  labs(title="Precio de la vivienda según mes de venta")  

```

```{r}
g <- ggplot(data, aes(MoSold))
g + geom_density(aes(fill=factor(YrSold)), alpha=0.4) + 
    labs(title="Meses de venta agrupados por años",
         x="Mes de venta",
         fill="# Año de venta")
```


```{r}
ggplot(data, aes(SalePrice, as.factor(MoSold))) +
geom_point() + coord_flip() +
facet_grid(YrSold ~ ., as.table=FALSE) +
theme_light() + scale_colour_gradientn(colours=rainbow(6))
```

```{r}
ggplot(data, aes(x=TotRmsAbvGrd, y=FullBath)) + 
  geom_bar(stat="identity", width=.5, fill="tomato3") + 
  labs(title="Número de habitaciones vs Número de baños") + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6))
```



```{r}
ggplot(data, aes(SalePrice)) +
geom_histogram(bins=nclass.Sturges(data$SalePrice)) +
xlab('Precio de las viviendas') +
ylab('') +
ggtitle('Histograma del precio de la vivienda')
```


```{r}
ggplot(data, aes(forcats::fct_infreq(LotConfig))) + 
  geom_bar()
```
```{r}
pie <- ggplot(data, aes(x = "", fill =Exterior1st )) + 
  geom_bar(width = 1) +
  theme(axis.line = element_blank(), 
        plot.title = element_text(hjust=0.5)) + 
  labs(fill="class", 
       x=NULL, 
       y=NULL, 
       title="Pie Chart of class", 
       caption="Source: mpg")
  
pie + coord_polar(theta = "y", start=0)
```


```{r}
ggplot(data, aes(forcats::fct_infreq(Neighborhood))) + 
  geom_bar() + 
  coord_flip()
```


```{r}
ggplot(data,
aes(reorder(Neighborhood, SalePrice), SalePrice)) +
geom_bar(stat='identity') + coord_flip()
```

```{r}
ggplot(data,
aes(reorder(Neighborhood, SalePrice), SalePrice)) +
geom_bar(stat='identity') + coord_flip()
```


```{r}
ggparcoord(data, columns=1:20, alphaLines=0.1,
scale='center', scaleSummary='median') +
xlab('') + ylab('') +
scale_x_discrete(labels=NULL) + theme_light()
```

```{r}
ggplot(data, aes(ExterQual, SalePrice, colour=YearBuilt)) +
  geom_point() + 
  facet_grid(LotConfig ~ ., as.table=FALSE) +
  theme_light() + 
  coord_flip() +
  scale_colour_gradientn(colours=rainbow(6))
```


```{r}
ggplot(data, aes(YearBuilt, SalePrice, colour=GarageQual)) +
  geom_point() + 
  facet_grid(as.factor(OverallQual) ~ ., as.table=FALSE) +
  coord_flip() +
  theme_bw()
```



# 4. Análisis gráfico de valores perdidos

```{r}
ggplot(data = data, aes(x=GarageYrBlt, y=SalePrice)) + 
  geom_missing_point()
```

```{r}
ggplot(data = data, aes(x=LotFrontage, y=SalePrice)) + geom_missing_point()
```


```{r}
ggplot(data = data, aes(x=MasVnrArea, y=SalePrice)) + geom_missing_point()
```



```{r}
ggplot(data = bind_shadow(data),
aes(x = SalePrice, color = LotFrontage_NA)) +
geom_density()
```

```{r}
ggplot(data = bind_shadow(data),
aes(x = SalePrice, color = MasVnrType_NA)) +
geom_density()
```

```{r}
ggplot(data = bind_shadow(data),
aes(x = SalePrice, color = MasVnrArea_NA)) +
geom_density()
```
```{r}
ggplot(data = bind_shadow(data),
aes(x = SalePrice, color = GarageYrBlt_NA)) +
geom_density()
```
```{r}
ggplot(data = bind_shadow(data),
aes(x = SalePrice, color = Electrical_NA)) +
geom_density()
```
```{r}
data %>% select(YearBuilt, YearRemodAdd) %>%    mutate(Remodeled = as.integer(YearBuilt != YearRemodAdd)) %>% ggplot(aes(x= factor(x = Remodeled, labels = c( 'No','Yes')))) + geom_bar(fill="steelblue", colour="gray") +  xlab('Remodeled') + theme_minimal() 
```


```{r}
gg_missing_var(data[,colSums(is.na(data)) > 0])
```

```{r}
visdat::vis_miss(data[,colSums(is.na(data)) > 0], cluster = TRUE, sort_miss = TRUE) + coord_flip()
```

```{r}
extracat::visna(data[,colSums(is.na(data)) > 0], sort = "b")
```


# 5. Análisis gráfico de valores atípicos

```{r}
ggplot(data, aes(1, SalePrice)) +
geom_boxplot() + coord_flip() +
xlab('') +
ylab('Precio de venta')
```


```{r}

ggplot(data, aes(SaleCondition, SalePrice)) +
geom_boxplot() 
```


```{r}
data %>%
select(SalePrice) %>%
filter(SalePrice > 350000)
```

```{r}
ggparcoord(data, columns = 2:10,
scale = "uniminmax") + theme_light()
```

```{r}
ggplot(data, aes(factor(Neighborhood), SalePrice)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 90, hjust =1)) + xlab('Neighborhoods')
```

```{r}
ggplot(data, aes(TotalBsmtSF, SalePrice)) + geom_point() +
geom_density2d(bins = 4, color = "red") +
geom_smooth()
```


```{r}
ggplot(data, aes(YearBuilt, SalePrice)) + geom_point() +
geom_density2d(bins = 4, color = "red") +
geom_smooth()
```

# 6. Análisis gráfico con  modelos

```{r}
modelo_lineal <- lm(SalePrice ~ TotalBsmtSF, data = data)

ggplot(data, aes(TotalBsmtSF, SalePrice)) + geom_point() +
geom_abline(intercept = coef(modelo_lineal)[1],
slope = coef(modelo_lineal)[2],
color = "red")
```



```{r}
modelo_lineal <- lm(SalePrice ~ TotalBsmtSF, data = data)

ggplot(data, aes(TotalBsmtSF, SalePrice)) + geom_point() +
geom_abline(intercept = coef(modelo_lineal)[1],
slope = coef(modelo_lineal)[2],
color = "red")
```

```{r}
data2 <- data %>% mutate(rel_price = resid(modelo_lineal))
ggplot(data2, aes(TotalBsmtSF, rel_price)) +
geom_point()
```

```{r}
deseas <- function(y, x) {
resid(lm(y ~ factor(x), na.action = na.exclude))
}


data3 <- data %>%
group_by(Neighborhood) %>%
mutate(rel_sales = deseas(OverallQual, SalePrice))

models <- data3 %>%
group_by(Neighborhood) %>%
do(mod = lm(log2(SalePrice) ~ OverallQual,
data = ., na.action = na.exclude))
head(models)
```

```{r}
model_sum <- models %>% broom::glance(mod)
head(model_sum, 4)
```
```{r}
ggplot(model_sum, aes(r.squared, reorder(Neighborhood, r.squared))) +
geom_point()
```

```{r}
obs_sum <- models %>% broom::augment(mod)
head(obs_sum, 5)

ggplot(obs_sum, aes(abs(.std.resid))) +
geom_histogram(binwidth = 0.1) + theme_light()
```
